ADR-0102: E27 Key Lifetimes and Session Identity Semantics

Status: Accepted
Date: 2025-12-23

Context
E27 uses multiple keys with different lifetimes:
- Link credentials (derived from API_LINK exchange) are provisioned once per app-panel pairing.
- HELLO occurs per TCP connection and yields per-connection session keys.
- AUTHENTICATE establishes an authenticated session_id used in subsequent commands.

Decision
We adopt the following key/identity semantics:

1) API_LINK (provisioning lifecycle):
   - API_LINK is used to pair the client application identity to the panel.
   - Output: link_key + link_hmac (persistent association, managed outside session runtime).
   - If access_code/pass_phrase are wrong, the panel may silently not respond; session must treat this as timeout-driven failure.

2) HELLO (connection lifecycle):
   - Executed on each new TCP connection.
   - Uses link_key/link_hmac to obtain session_key + session_hmac (ephemeral per connection).
   - These keys are retained only in memory for the life of the TCP connection/session.

3) AUTHENTICATE (authenticated lifecycle):
   - Uses session_key to encrypt the authenticate command.
   - Returns a session_id (integer) that is included in subsequent commands.
   - session_id is treated as an authenticated session handle, not a key.

Consequences
- Losing TCP connection implies losing session_key/session_hmac and requires HELLO again.
- Pairing state (link_key/link_hmac) must be provisioned/retrieved before HELLO/AUTH; storage is explicitly outside core protocol modules.

Related
- DDR-0020 (silent failure / no-response on incorrect creds)
- DDR-0022 (linking.py responsibility for api_link exchange)
- DDR-0024 (session lifecycle)
