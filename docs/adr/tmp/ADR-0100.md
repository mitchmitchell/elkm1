ADR-0100: E27 Framing, Escaping, Length, and CRC Semantics

Status: Accepted
Date: 2025-12-23

Context
E27 panel traffic uses a byte-stream framing protocol distinct from JSON application semantics. We must parse reliably over TCP segmentation, handle multiple frames per read, and resynchronize after corruption. Node-RED reference behavior includes a resync rule involving STARTCHAR (0x7E).

Decision
We implement an E27 framing layer with the following rules:

1) Frame format on the wire:
   - STARTCHAR 0x7E
   - protocol byte (non-zero)
   - length (2 bytes, little-endian) where length includes:
       protocol + len(2) + payload + crc(2)
     i.e. total bytes AFTER STARTCHAR.
   - payload bytes (ciphertext or plaintext data_frame)
   - CRC16 (2 bytes, little-endian) computed over:
       protocol + len(2) + payload  (NOT including STARTCHAR, NOT including CRC bytes)

2) Escaping:
   - Literal 0x7E inside the stream is encoded as 0x7E 0x00.
   - Deframer restores 0x7E 0x00 -> 0x7E in payload and header stream.

3) Resync rule (Node-RED compatible):
   - If a 0x7E is seen and the following byte is non-zero, that byte is ALWAYS treated as a new protocol byte
     starting a new frame (dropping any partial prior frame).

4) Error handling:
   - CRC failure produces an error result but does not stop parsing; the deframer continues scanning for the next frame.
   - TCP segmentation and coalescing are expected; the deframer accepts arbitrary chunking and may emit 0..N frames.

5) API shape:
   - framing exports a builder `frame_build(protocol_byte, data_frame)` and a streaming deframer `deframe_feed(state, chunk)`
     that returns a list of results (success and error entries) for downstream session logic.

Consequences
- Framing becomes the authoritative boundary for “message receive” on a TCP stream.
- Session receive code must treat deframer output as the unit of work and must not assume a 1:1 relationship between recv() and frames.
- This decouples protocol reliability (framing) from crypto and JSON parsing.

Related
- DDR-0024 (Session lifecycle and framed vs unframed traffic)
- DDR-0025 (E27 framing module behavior & test coverage)
