ADR-0100: E27 Framing Semantics (STARTCHAR, Length, CRC, Escape, Resync)

Status: Accepted

Context
The E27 TCP protocol uses a byte-framed transport with explicit framing,
escaping, and CRC validation. Correct interpretation of this framing is
required to ensure message boundary detection, error recovery, and
interoperability with existing Elk tooling and Node-RED implementations.

Decision
The following framing semantics are defined as canonical for E27:

1. Frame Structure (on the wire)
   - STARTCHAR (0x7E)
   - Protocol byte (1 byte)
   - Length (2 bytes, little-endian)
   - Payload bytes (length-defined)
   - CRC16 (2 bytes, little-endian)

2. Length Semantics
   - Length includes:
     - protocol byte
     - payload bytes
   - Length does NOT include:
     - STARTCHAR
     - CRC

3. Escaping Rules
   - Any literal 0x7E in the payload is escaped as:
       0x7E 0x00
   - During deframing, 0x7E followed by 0x00 is restored to a literal 0x7E.

4. Resynchronization Rule (Node-RED compatible)
   - A STARTCHAR followed by a NON-zero byte ALWAYS begins a new frame.
   - The byte following STARTCHAR is treated as the protocol byte.
   - Any partially accumulated frame is discarded.

5. CRC Semantics
   - CRC16 is computed over:
       protocol + length + payload
   - CRC failure:
       - Emits a framing error
       - Does NOT abort the stream
       - Deframer continues scanning for the next valid STARTCHAR

Consequences
- Framing is resilient to corruption and mid-stream resynchronization.
- Partial frames do not poison subsequent traffic.
- Multiple frames per TCP chunk are supported.
- TCP segmentation boundaries are irrelevant to correctness.
