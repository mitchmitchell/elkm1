ADR-0101: E27 Schema-0 Envelope Encryption/Decryption and Cryptography Library

Status: Accepted
Date: 2025-12-23

Context
After HELLO, E27 exchanges encrypted messages (schema-0) where ciphertext is framed (ADR-0100). We need deterministic, testable crypto primitives with minimal external dependencies.

Decision
1) Library choice:
   - Use Python `cryptography` (hazmat primitives) for AES operations:
     from cryptography.hazmat.primitives.ciphers import Cipher, algorithms, modes

2) Schema-0 envelope:
   - Encryption/decryption operates on UTF-8 JSON bytes (payload).
   - The presentation layer is responsible for:
       - generating IVs
       - applying padding rules required by the E27 schema
       - performing AES encryption/decryption
       - returning/accepting (protocol_byte, ciphertext) for framing

3) Module boundary:
   - `presentation.py` owns schema-0 encrypt/decrypt functions (pure functions, no socket I/O).
   - `framing.py` owns stream framing/deframing (pure functions + streaming state).
   - `session.py` owns receive pump and sequencing; it calls framing + presentation.

4) Error behavior:
   - Decrypt failures must fail “cleanly” (surface an error to the session layer) and not crash parsing.
   - The session layer decides whether to retry, tear down connection, or escalate to provisioning.

Consequences
- Crypto correctness can be unit-tested without hardware (round-trip tests).
- The session layer remains readable and does not embed cryptographic details.

Related
- DDR-0021 (cryptography dependency decision)
- DDR-0025 (round-trip + framing tests)
