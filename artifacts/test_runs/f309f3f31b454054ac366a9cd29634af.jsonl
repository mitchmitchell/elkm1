{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_presentation.py::test_e27_presentation", "record_type": "test_start", "t_ms": 0, "ts_utc": "2025-12-27T04:44:25Z", "meta": {"pid": 79823}}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_presentation.py::test_e27_presentation", "record_type": "test_end", "t_ms": 5, "ts_utc": "2025-12-27T04:44:25Z", "outcome": "pass", "error": null}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_presentation.py::test_e27_presentation_rejects_non_encrypted_protocol_byte", "record_type": "test_start", "t_ms": 0, "ts_utc": "2025-12-27T04:44:25Z", "meta": {"pid": 79823}}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_presentation.py::test_e27_presentation_rejects_non_encrypted_protocol_byte", "record_type": "test_end", "t_ms": 0, "ts_utc": "2025-12-27T04:44:25Z", "outcome": "pass", "error": null}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_presentation.py::test_e27_presentation_magic_mismatch_raises", "record_type": "test_start", "t_ms": 0, "ts_utc": "2025-12-27T04:44:25Z", "meta": {"pid": 79823}}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_presentation.py::test_e27_presentation_magic_mismatch_raises", "record_type": "test_end", "t_ms": 0, "ts_utc": "2025-12-27T04:44:25Z", "outcome": "pass", "error": null}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_presentation.py::test_e27_presentation_decrypt_api_link_response_roundtrip_minimal", "record_type": "test_start", "t_ms": 0, "ts_utc": "2025-12-27T04:44:25Z", "meta": {"pid": 79823}}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_presentation.py::test_e27_presentation_decrypt_api_link_response_roundtrip_minimal", "record_type": "test_end", "t_ms": 0, "ts_utc": "2025-12-27T04:44:25Z", "outcome": "pass", "error": null}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_presentation.py::test_e27_presentation_decrypt_key_field_with_linkkey_roundtrip", "record_type": "test_start", "t_ms": 0, "ts_utc": "2025-12-27T04:44:25Z", "meta": {"pid": 79823}}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_presentation.py::test_e27_presentation_decrypt_key_field_with_linkkey_roundtrip", "record_type": "test_end", "t_ms": 0, "ts_utc": "2025-12-27T04:44:25Z", "outcome": "pass", "error": null}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_session.py::test_connect_establishes_tcp_and_performs_hello", "record_type": "test_start", "t_ms": 0, "ts_utc": "2025-12-27T04:44:25Z", "meta": {"pid": 79823}}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_session.py::test_connect_establishes_tcp_and_performs_hello", "record_type": "test_end", "t_ms": 14, "ts_utc": "2025-12-27T04:44:25Z", "outcome": "fail", "error": {"when": "call", "longrepr": "monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x109382b10>\n\n    def test_connect_establishes_tcp_and_performs_hello(monkeypatch: pytest.MonkeyPatch) -> None:\n        fake_sock = _FakeSocket()\n    \n        # Patch socket.socket(...) to return our fake.\n        def _fake_socket_ctor(*args: Any, **kwargs: Any) -> _FakeSocket:\n            return fake_sock\n    \n        monkeypatch.setattr(session_mod.socket, \"socket\", _fake_socket_ctor)\n    \n        # Patch HELLO to return deterministic keys.\n        keys = _HelloKeys(session_id=7, session_key_hex=\"aa\" * 16, session_hmac_hex=\"bb\" * 20)\n    \n        def _fake_perform_hello(*, sock: Any, identity: linking.E27Identity, linkkey_hex: str, timeout_s: float) -> _HelloKeys:\n            assert sock is fake_sock\n            assert identity.mn == \"0222\"\n            assert linkkey_hex == \"cc\" * 16\n            assert timeout_s == 9.0\n            return keys\n    \n        monkeypatch.setattr(session_mod, \"perform_hello\", _fake_perform_hello)\n    \n        cfg = session_mod.SessionConfig(host=\"10.0.0.5\", port=2101, connect_timeout_s=3.0, io_timeout_s=0.25, hello_timeout_s=9.0)\n        identity = linking.E27Identity(mn=\"0222\", sn=\"001122334455\", fwver=\"1.0\", hwver=\"1.0\", osver=\"1.0\")\n        s = session_mod.Session(cfg, identity=identity, link_key_hex=\"cc\" * 16)\n    \n        captured: dict[str, Any] = {}\n    \n        def _on_connected(info: session_mod.SessionInfo) -> None:\n            captured[\"info\"] = info\n    \n        s.on_connected = _on_connected\n    \n>       info = s.connect()\n               ^^^^^^^^^^^\n\ntest/test_e27_session.py:134: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nself = <elke27_lib.session.Session object at 0x10958f8c0>\n\n    def connect(self) -> SessionInfo:\n        \"\"\"\n        Connect TCP and perform HELLO to obtain session keys.\n        \"\"\"\n        if self.state is not SessionState.DISCONNECTED:\n            # Mechanical safety: connect() is intended to establish a new session.\n            self.close()\n    \n        self.last_error = None\n        self.state = SessionState.CONNECTING\n    \n        logger.info(\"E27 Session connecting to %s:%s\", self.cfg.host, self.cfg.port)\n        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)\n        try:\n            s.settimeout(self.cfg.connect_timeout_s)\n            s.connect((self.cfg.host, self.cfg.port))\n        except OSError as e:\n            self.last_error = e\n            self.state = SessionState.DISCONNECTED\n            try:\n                s.close()\n            except Exception:\n                pass\n            raise SessionIOError(\n                f\"Failed to connect to {self.cfg.host}:{self.cfg.port}: {e}\"\n            ) from e\n    \n        # After connect, switch to pump cadence timeout.\n        s.settimeout(self.cfg.io_timeout_s)\n        self.sock = s\n        self._deframe_state = DeframeState()\n    \n        self.state = SessionState.HELLO\n        try:\n            keys = perform_hello(\n                sock=s,\n                identity=self.identity,\n                linkkey_hex=self.link_key_hex,\n                timeout_s=self.cfg.hello_timeout_s,\n            )\n        except Exception as e:\n            self.last_error = e\n            # HELLO failure is a session setup failure; close and surface clearly.\n            self._handle_disconnect(e)\n            raise SessionProtocolError(\n                f\"HELLO failed for {self.cfg.host}:{self.cfg.port}: {e}\"\n            ) from e\n    \n        self.info = SessionInfo(\n            session_id=keys.session_id,\n            session_key_hex=keys.session_key_hex,\n>           session_hmac_hex=keys.hmac_key_hex,\n                             ^^^^^^^^^^^^^^^^^\n        )\nE       AttributeError: '_HelloKeys' object has no attribute 'hmac_key_hex'\n\nelke27_lib/session.py:171: AttributeError"}}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_session.py::test_close_is_idempotent", "record_type": "test_start", "t_ms": 0, "ts_utc": "2025-12-27T04:44:25Z", "meta": {"pid": 79823}}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_session.py::test_close_is_idempotent", "record_type": "test_end", "t_ms": 0, "ts_utc": "2025-12-27T04:44:25Z", "outcome": "pass", "error": null}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_session.py::test_send_json_encrypts_frames_and_sendall", "record_type": "test_start", "t_ms": 0, "ts_utc": "2025-12-27T04:44:25Z", "meta": {"pid": 79823}}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_session.py::test_send_json_encrypts_frames_and_sendall", "record_type": "test_end", "t_ms": 4, "ts_utc": "2025-12-27T04:44:25Z", "outcome": "fail", "error": {"when": "call", "longrepr": "monkeypatch = <_pytest.monkeypatch.MonkeyPatch object at 0x108c2a330>\n\n    def test_send_json_encrypts_frames_and_sendall(monkeypatch: pytest.MonkeyPatch) -> None:\n        s, fake_sock = _make_session_ready(monkeypatch)\n    \n        # Patch encrypt_schema0_envelope to return a protocol byte + ciphertext.\n        def _fake_encrypt_schema0_envelope(\n            *,\n            payload: bytes,\n            session_key: bytes,\n            src: int,\n            dest: int,\n            head: int,\n            envelope_seq: int,\n>           iv: bytes = session_mod.API_LINK_IV,\n                        ^^^^^^^^^^^^^^^^^^^^^^^\n        ) -> tuple[int, bytes]:\nE       AttributeError: module 'elke27_lib.session' has no attribute 'API_LINK_IV'\n\ntest/test_e27_session.py:181: AttributeError"}}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_session.py::test_recv_json_deframes_decrypts_and_parses", "record_type": "test_start", "t_ms": 0, "ts_utc": "2025-12-27T04:44:25Z", "meta": {"pid": 79823}}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_session.py::test_recv_json_deframes_decrypts_and_parses", "record_type": "test_end", "t_ms": 0, "ts_utc": "2025-12-27T04:44:25Z", "outcome": "pass", "error": null}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_session.py::test_recv_json_rejects_short_frame", "record_type": "test_start", "t_ms": 0, "ts_utc": "2025-12-27T04:44:25Z", "meta": {"pid": 79823}}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_session.py::test_recv_json_rejects_short_frame", "record_type": "test_end", "t_ms": 0, "ts_utc": "2025-12-27T04:44:25Z", "outcome": "pass", "error": null}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_session.py::test_recv_json_rejects_non_object_json", "record_type": "test_start", "t_ms": 0, "ts_utc": "2025-12-27T04:44:25Z", "meta": {"pid": 79823}}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_session.py::test_recv_json_rejects_non_object_json", "record_type": "test_end", "t_ms": 0, "ts_utc": "2025-12-27T04:44:25Z", "outcome": "pass", "error": null}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_session.py::test_recv_json_rejects_invalid_json", "record_type": "test_start", "t_ms": 0, "ts_utc": "2025-12-27T04:44:25Z", "meta": {"pid": 79823}}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_session.py::test_recv_json_rejects_invalid_json", "record_type": "test_end", "t_ms": 0, "ts_utc": "2025-12-27T04:44:25Z", "outcome": "pass", "error": null}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_session.py::test_recv_one_frame_no_crc_uses_deframe_state_and_feed", "record_type": "test_start", "t_ms": 0, "ts_utc": "2025-12-27T04:44:25Z", "meta": {"pid": 79823}}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_session.py::test_recv_one_frame_no_crc_uses_deframe_state_and_feed", "record_type": "test_end", "t_ms": 0, "ts_utc": "2025-12-27T04:44:25Z", "outcome": "pass", "error": null}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_session.py::test_pump_once_timeout_returns_none", "record_type": "test_start", "t_ms": 0, "ts_utc": "2025-12-27T04:44:25Z", "meta": {"pid": 79823}}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_session.py::test_pump_once_timeout_returns_none", "record_type": "test_end", "t_ms": 0, "ts_utc": "2025-12-27T04:44:25Z", "outcome": "pass", "error": null}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_session.py::test_pump_once_dispatches_on_message", "record_type": "test_start", "t_ms": 0, "ts_utc": "2025-12-27T04:44:25Z", "meta": {"pid": 79823}}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_session.py::test_pump_once_dispatches_on_message", "record_type": "test_end", "t_ms": 0, "ts_utc": "2025-12-27T04:44:25Z", "outcome": "pass", "error": null}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_session.py::test_pump_once_disconnects_and_emits_on_disconnected", "record_type": "test_start", "t_ms": 0, "ts_utc": "2025-12-27T04:44:25Z", "meta": {"pid": 79823}}
{"run_id": "f309f3f31b454054ac366a9cd29634af", "test_id": "test/test_e27_session.py::test_pump_once_disconnects_and_emits_on_disconnected", "record_type": "test_end", "t_ms": 0, "ts_utc": "2025-12-27T04:44:25Z", "outcome": "pass", "error": null}
